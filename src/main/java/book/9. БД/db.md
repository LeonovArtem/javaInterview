# **Базы данных**

* Что такое транзакция?
* ACID
* Проблемы параллельного доступа с использованием транзакций
* Уровни изолированности транзакций

## Что такое транзакция?

## ACID
* **Атомарность (atomicity).** Атомарность гарантирует, что никакая транзакция
не будет зафиксирована частично. 
* **Согласованность (consistency).** Каждая успешная транзакция фиксирует только допустимые
  результаты (foreign key, constraint).
* **Изолированность (isolation).** Во время выполнения транзакции параллельные транзакции
не должны оказывать влияния на ее результат.
* **Долговечность (durability).** Независимо от проблем на нижних уровнях изменения, 
сделанные успешно завершённой транзакцией, должны остаться сохранёнными после 
возвращения системы в работу.

## Проблемы параллельного доступа с использованием транзакций
**Грязное чтение (dirty read).**  чтение данных, добавленных или изменённых транзакцией,
которая впоследствии не подтвердится (откатится).

**Пример:**

| **Transaction 1**                    | **Transaction 2**                                             |
|--------------------------------------|---------------------------------------------------------------|
| `INSERT INTO table VALUES (value);`  |                                                               |
|                                      | `SELECT COUNT(*) FROM table;` <br/> `COMMIT;`<br/> Result: 1  |
| `ROLLBACK;`                          |                                                               | 

**Потерянное обновление (lost update).** При одновременном изменении одного блока данных разными 
транзакциями теряются все изменения, кроме последнего.

**Пример:**
Начальное значение `counter` = 0.

| **Transaction 1**                                                                                       | **Transaction 2**                                                                                       |
|---------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|
| `SELECT value FROM counter INTO @value;` <br/> `UPDATE counter SET value = @value +1;` <br/> `COMMIT;`  | `SELECT value FROM counter INTO @value;` <br/> `UPDATE counter SET value = @value +1;` <br/> `COMMIT;`  | 

В результате значение `counter` = 1.

**Неповторяющееся чтение (non-repeatable read).** При повторном чтении в рамках одной 
транзакции ранее прочитанные данные оказываются изменёнными.

**Пример:**

| **Transaction 1**             | **Transaction 2**                                         |
|-------------------------------|-----------------------------------------------------------|
| `SELECT value FROM counter;`  |                                                           |
|                               | `UPDATE counter SET value = @value +1;` <br/> `COMMIT;`   |
| `SELECT value FROM counter;`  |                                                           |
|                               |                                                           |

**Фантомное чтение (phantom reads).** Ситуация, когда при повторном чтении в рамках одной транзакции одна 
и та же выборка дает разные множества строк.

**Пример:**

| **Transaction 1**               | **Transaction 2**                                   |
|---------------------------------|-----------------------------------------------------|
| `SELECT COUNT(*) FROM table;`   |                                                     |
|                                 | `INSERT INTO table VALUES (value);` <br/> `COMMIT;` |
| `SELECT COUNT(*) FROM table;`   |                                                     |
|                                 |                                                     |

## Уровни изолированности транзакций
* **Read uncommitted.** Чтение незафиксированных изменений как своей транзакции, 
так и параллельных транзакций.
* **Read committed.** Параллельно выполняющиеся транзакции видят только
зафиксированные изменения из других транзакций.
* **Repeatable read.** Не видны изменения ```UPDATE``` и ```DELETE```, но видны результаты
```INSERT``` (после коммита). Фантомное чтение, в innoDB проблема фантомного чтения решена.
* **Serializable.**.  Полностью исключает влияние других транзакций.